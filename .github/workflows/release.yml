name: Build

on:
  workflow_dispatch:
    inputs:
      manual_tag:
        description: 'Tag for the build'
        required: True

  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      actions: write
      contents: write

    steps:
      - name: Checkout Main
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - name: Get Discord SDK
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.SDK_ACCESS_TOKEN }}
        run: |
          $LATEST_TAG = gh release view --repo Amqx/discord-social-sdk --json tagName -q '.tagName'
          Write-Host "Latest release tag: $LATEST_TAG"
          gh release download --repo Amqx/discord-social-sdk "$LATEST_TAG" --pattern "*.zip" --dir discordsdk_tmp
          
          $zip = Get-ChildItem discordsdk_tmp -Filter *.zip | Select-Object -First 1
          Expand-Archive -Path $zip.FullName -DestinationPath discordsdk -Force
          Remove-Item discordsdk_tmp -Recurse -Force

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Dependencies
        shell: pwsh
        run: |
          $chocoJob = Start-Job -ScriptBlock { 
            choco install -y pkgconfiglite ninja innosetup
          }
          $vcpkgJob = Start-Job -ScriptBlock {
            vcpkg install ffmpeg:x64-windows curl:x64-windows cppwinrt:x64-windows leveldb:x64-windows spdlog:x64-windows libxml2:x64-windows nlohmann-json:x64-windows
          }
          
          Wait-Job $chocoJob, $vcpkgJob
          Receive-Job $chocoJob
          Receive-Job $vcpkgJob

      - name: Configure and build
        shell: pwsh
        run: |
          cmake -S . -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DVCPKG_TARGET_TRIPLET=x64-windows
          cmake --build build

      - name: Package ZIP
        shell: pwsh
        run: |
          $TAG = "${{ github.event.inputs.manual_tag }}"
          if (-not $TAG) { $TAG = "${{ github.ref_name }}" }
          if (-not $TAG) { $TAG = "manual-build" }
          
          if ($TAG -eq "main") { $TAG = "build-${{ github.run_number }}" }
          
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          
          $exe = Get-ChildItem build -Recurse -Filter musicpp.exe | Select-Object -First 1
          Copy-Item $exe.FullName dist/
          
          Get-ChildItem build -Recurse -Filter *.dll | ForEach-Object {
            Copy-Item $_.FullName dist/ -Force
          }
          
          $ZipName = "musicpp-$TAG-windows.zip"
          Compress-Archive -Path dist/* -DestinationPath $ZipName
          
          echo "ZIP_NAME=$ZipName" >> $env:GITHUB_ENV
          echo "RELEASE_TAG=$TAG" >> $env:GITHUB_ENV

      - name: Build Installer
        shell: pwsh
        run: |
          $ISCC = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          New-Item -ItemType Directory -Force -Path installer_out | Out-Null
          
          & $ISCC "installer\installer.iss" `
            "/DVersion=${{ env.RELEASE_TAG }}" `
            "/DSourceDir=$(Resolve-Path dist)" `
            "/DOutputDir=$(Resolve-Path installer_out)" `
            "/DOutputBaseFilename=musicpp-${{ env.RELEASE_TAG }}-setup"
          
          $installerExe = Get-ChildItem installer_out -Filter *.exe | Select-Object -First 1
          echo "INSTALLER_EXE=$($installerExe.FullName)" >> $env:GITHUB_ENV

      - name: Upload to Releases
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.ZIP_NAME }}
            ${{ env.INSTALLER_EXE }}
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
