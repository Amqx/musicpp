name: Build

on:
  workflow_dispatch:
    inputs:
      manual_tag:
        description: 'Tag for the build'
        required: True

  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      actions: write
      contents: write

    steps:
      - name: Checkout Main
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Get Discord SDK
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.SDK_ACCESS_TOKEN }}
        run: |
          Set-Location $env:GITHUB_WORKSPACE
          $LATEST_TAG = gh release view --repo Amqx/discord-social-sdk --json tagName -q '.tagName'
          Write-Host "Latest release tag: $LATEST_TAG"
          gh release download --repo Amqx/discord-social-sdk "$LATEST_TAG" --pattern "*.zip" --dir discordsdk_tmp
          
          $zip = Get-ChildItem discordsdk_tmp -Filter *.zip | Select-Object -First 1
          Expand-Archive -Path $zip.FullName -DestinationPath discordsdk -Force
          Remove-Item discordsdk_tmp -Recurse -Force

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1

      - name: Install Dependencies
        shell: pwsh
        run: |
          $chocoJob = Start-Job -ScriptBlock { 
            choco install -y pkgconfiglite ninja innosetup
          }
          $vcpkgJob = Start-Job -ScriptBlock {
            $env:VCPKG_ROOT = "C:\vcpkg"
            vcpkg install ffmpeg:x64-windows curl:x64-windows cppwinrt:x64-windows leveldb:x64-windows spdlog:x64-windows libxml2:x64-windows nlohmann-json:x64-windows
          }
          
          Wait-Job $chocoJob, $vcpkgJob
          Receive-Job $chocoJob
          Receive-Job $vcpkgJob

      - name: Configure and build
        shell: pwsh
        run: |
          cmake -S "$env:GITHUB_WORKSPACE" -B "$env:GITHUB_WORKSPACE/build" -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DVCPKG_TARGET_TRIPLET=x64-windows
          cmake --build "$env:GITHUB_WORKSPACE/build"

      - name: Package ZIP
        shell: pwsh
        run: |
          $TAG = "${{ github.event.inputs.manual_tag }}"
          if (-not $TAG) { $TAG = "${{ github.ref_name }}" }
          if (-not $TAG) { $TAG = "manual-build" }
          
          if ($TAG -eq "main") { $TAG = "build-${{ github.run_number }}" }
          
          $distPath = Join-Path $env:GITHUB_WORKSPACE "dist"
          New-Item -ItemType Directory -Force -Path $distPath | Out-Null
          
          $exe = Get-ChildItem "$env:GITHUB_WORKSPACE/build" -Recurse -Filter musicpp.exe | Select-Object -First 1
          Copy-Item $exe.FullName $distPath/
          
          Get-ChildItem "$env:GITHUB_WORKSPACE/build" -Recurse -Filter *.dll | ForEach-Object {
            Copy-Item $_.FullName $distPath/ -Force
          }
          
          $ZipName = "musicpp-$TAG-windows.zip"
          $ZipPath = Join-Path $env:GITHUB_WORKSPACE $ZipName
          Compress-Archive -Path "$distPath/*" -DestinationPath $ZipPath
          
          echo "ZIP_NAME=$ZipName" >> $env:GITHUB_ENV
          echo "RELEASE_TAG=$TAG" >> $env:GITHUB_ENV
          echo "DIST_PATH=$distPath" >> $env:GITHUB_ENV

      - name: Build Installer
        shell: pwsh
        run: |
          $ISCC = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $ISCC)) { $ISCC = "ISCC.exe" } # Fallback to PATH
          
          $outPath = Join-Path $env:GITHUB_WORKSPACE "installer_out"
          New-Item -ItemType Directory -Force -Path $outPath | Out-Null
          
          & $ISCC "$env:GITHUB_WORKSPACE/installer/installer.iss" `
            "/DVersion=${{ env.RELEASE_TAG }}" `
            "/DSourceDir=${{ env.DIST_PATH }}" `
            "/DOutputDir=$outPath" `
            "/DOutputBaseFilename=musicpp-${{ env.RELEASE_TAG }}-setup"
          
          $installerExe = Get-ChildItem $outPath -Filter *.exe | Select-Object -First 1
          echo "INSTALLER_EXE=$($installerExe.FullName)" >> $env:GITHUB_ENV

      - name: Upload to Releases
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            ${{ env.ZIP_NAME }}
            ${{ env.INSTALLER_EXE }}
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
